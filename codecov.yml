# Codecov configuration for Sidechain
# Backend Go coverage reporting with component-based organization

codecov:
  branch: main
  max_report_age: "12h"
  notify:
    require_ci_to_pass: false
    after_n_builds: 1

coverage:
  precision: 2
  round: down
  range: 70..100

  status:
    default_rules:
      flag_coverage_not_uploaded_behavior: include

    project:
      default:
        target: auto
        threshold: 5%
        branches:
          - main

      # Auth service (critical)
      auth:
        target: 80%
        threshold: 5%
        paths:
          - "backend/internal/auth/**/*"

      # API handlers
      handlers:
        target: 75%
        threshold: 5%
        paths:
          - "backend/internal/handlers/**/*"

      # getstream.io integration
      stream:
        target: 60%
        threshold: 5%
        paths:
          - "backend/internal/stream/**/*"
        informational: true

      # Database layer
      database:
        target: 75%
        threshold: 5%
        paths:
          - "backend/internal/database/**/*"

      # Models
      models:
        target: 70%
        threshold: 5%
        paths:
          - "backend/internal/models/**/*"

      # Plugin (C++)
      plugin:
        target: 60%
        threshold: 5%
        paths:
          - "plugin/Source/**/*"

    patch:
      default:
        target: 80%
        threshold: 5%
        base: auto
        branches:
          - main
        if_ci_failed: error
        only_pulls: true
        informational: false

      core_patch:
        target: 80%
        threshold: 5%
        base: auto
        paths:
          - "backend/internal/auth/**/*"
          - "backend/internal/handlers/**/*"
          - "backend/internal/database/**/*"
        branches:
          - main
        if_ci_failed: error
        only_pulls: true

    changes:
      default:
        if_ci_failed: error
        branches:
          - main

component_management:
  default_rules:
    paths:
      - "backend/**/*"
    flag_regexes:
      - "backend"
    statuses:
      - type: project
        target: auto
        threshold: 5%
      - type: patch
        target: 80%
        threshold: 5%

  individual_components:
    - component_id: auth
      name: "Authentication"
      paths:
        - "backend/internal/auth/**/*"
      statuses:
        - type: project
          target: 80%
          threshold: 5%
        - type: patch
          target: 80%

    - component_id: handlers
      name: "API Handlers"
      paths:
        - "backend/internal/handlers/**/*"
      statuses:
        - type: project
          target: 75%
          threshold: 5%
        - type: patch
          target: 80%

    - component_id: stream
      name: "Stream.io Integration"
      paths:
        - "backend/internal/stream/**/*"
      statuses:
        - type: project
          target: 60%
          threshold: 5%
          informational: true

    - component_id: database
      name: "Database Layer"
      paths:
        - "backend/internal/database/**/*"
      statuses:
        - type: project
          target: 75%
          threshold: 5%

    - component_id: models
      name: "Data Models"
      paths:
        - "backend/internal/models/**/*"
      statuses:
        - type: project
          target: 70%
          threshold: 5%

    # Plugin components
    - component_id: plugin_core
      name: "Plugin Core"
      paths:
        - "plugin/Source/**/*"
      statuses:
        - type: project
          target: 60%
          threshold: 5%
        - type: patch
          target: 70%

    - component_id: plugin_network
      name: "Plugin Network"
      paths:
        - "plugin/Source/NetworkClient.*"
      statuses:
        - type: project
          target: 70%
          threshold: 5%

    - component_id: plugin_ui
      name: "Plugin UI"
      paths:
        - "plugin/Source/PluginEditor.*"
        - "plugin/Source/*Indicator.*"
      statuses:
        - type: project
          target: 60%
          threshold: 10%
          informational: true

comment:
  layout: "header, diff, flags, components, footer"
  behavior: default
  require_changes: false
  require_base: false
  require_head: true
  branches:
    - main
  show_carryforward_flags: false

ignore:
  - "backend/cmd/**/*"
  - "backend/vendor/**/*"
  - "frontend/**/*"
  - "deps/**/*"
  - "*.md"
  - ".github/**/*"
  - "notes/**/*"

flags:
  backend:
    paths:
      - "backend/"
    carryforward: false
  plugin:
    paths:
      - "plugin/Source/"
      - "plugin/tests/"
    carryforward: false

github_checks:
  annotations: true

profiling:
  critical_files_paths:
    - "backend/internal/auth/**/*"
    - "backend/internal/handlers/**/*"
    - "backend/internal/database/**/*"
