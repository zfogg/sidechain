name: Build and Deploy Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'plugin/**/*.cpp'
      - 'plugin/**/*.h'
      - 'backend/**/*.go'
      - '.github/workflows/docs.yml'
      - 'docs/CMakeLists.txt'
      - 'docs/conf.py'
      - 'docs/**/*.rst'
      - 'docs/**/*.md'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git tags/version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install -r docs/requirements.txt
          # Verify Sphinx is installed
          python3 -m sphinx --version

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install Go documentation tool
        run: |
          go install golang.org/x/pkgsite/cmd/pkgsite@latest

      - name: Set up Node.js (for plugin build tools if needed)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build plugin documentation (Doxygen only - no C++ compilation)
        env:
          DOXYGEN_XML_DIR: ${{ github.workspace }}/docs/doxygen/xml
        run: |
          # Install only documentation tools - no C++ build dependencies
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz cmake

          # Build docs directly from docs/ directory (standalone, no plugin build)
          # This only runs Doxygen to parse C++ source files (no compilation)
          cd docs
          cmake -S . -B build-docs

          cmake --build build-docs --target docs-doxygen

          # Doxygen XML is already in the expected location: docs/build-docs/doxygen/xml
          # Copy it to docs/doxygen/xml for Sphinx
          if [ -d "build-docs/doxygen/xml" ]; then
            echo "Copying Doxygen XML to expected location for Sphinx"
            mkdir -p "${{ github.workspace }}/docs/doxygen"
            cp -r build-docs/doxygen/xml "${{ github.workspace }}/docs/doxygen/"
          else
            echo "Warning: Doxygen XML not found, creating placeholder"
            mkdir -p "${{ github.workspace }}/docs/doxygen/xml"
          fi

      - name: Generate Go package documentation
        run: |
          # Install wget and curl for downloading pkgsite pages
          sudo apt-get install -y wget curl
          
          # Generate pkgsite HTML documentation (pkg.go.dev style)
          mkdir -p docs/_build/html/backend/godoc
          
          # Change to backend directory so pkgsite can find the Go modules
          cd backend
          
          # Start pkgsite server in background from backend directory
          # Use -cache flag to serve from module cache (works for local packages)
          # Redirect output to see any errors
          ~/go/bin/pkgsite -cache -http=:8080 . > /tmp/pkgsite.log 2>&1 &
          PKGSITE_PID=$!
          
          # Wait for server to start and verify it's running
          echo "Waiting for pkgsite server to start..."
          for i in {1..20}; do
            sleep 1
            if curl -s http://localhost:8080/ > /dev/null 2>&1; then
              echo "✓ Pkgsite server is running"
              break
            fi
            if [ $i -eq 20 ]; then
              echo "✗ Pkgsite server failed to start after 20 seconds"
              echo "Pkgsite log:"
              cat /tmp/pkgsite.log 2>/dev/null || echo "(no log available)"
              # Check if process is still running
              if ps -p $PKGSITE_PID > /dev/null 2>&1; then
                echo "Pkgsite process is running but not responding"
              else
                echo "Pkgsite process exited"
              fi
              kill $PKGSITE_PID 2>/dev/null || true
              exit 1
            fi
          done
          
          # Go back to workspace root
          cd ${{ github.workspace }}
          
          # Download all package pages and assets using wget mirror
          # This automatically converts links to be relative
          echo "Downloading pkgsite documentation and assets..."
          # pkgsite uses /github.com/username/repo/... path structure
          PACKAGE_PATH="github.com/zfogg/sidechain/backend"
          
          # First verify the package exists
          TEST_DOWNLOAD=$(curl -s http://localhost:8080/${PACKAGE_PATH}/ | head -20)
          if [ -n "$TEST_DOWNLOAD" ]; then
            echo "Package path verified, downloading with automatic link conversion..."
            
            # First download the static assets directory
            echo "Downloading static assets..."
            wget \
              --mirror \
              --convert-links \
              --adjust-extension \
              --page-requisites \
              --no-parent \
              --no-host-directories \
              --cut-dirs=0 \
              --directory-prefix=docs/_build/html/backend/godoc \
              --accept="*.css,*.js,*.woff,*.woff2,*.ttf,*.svg,*.png,*.ico" \
              --reject="*.html,robots.txt" \
              --quiet \
              --level=5 \
              http://localhost:8080/static/ || echo "Note: Some static assets may not be available"
            
            # Then download the package pages (including all subpackages)
            echo "Downloading package pages..."
            wget \
              --mirror \
              --convert-links \
              --adjust-extension \
              --page-requisites \
              --no-parent \
              --no-host-directories \
              --cut-dirs=0 \
              --directory-prefix=docs/_build/html/backend/godoc \
              --accept="*.html" \
              --reject="robots.txt" \
              --quiet \
              --level=15 \
              http://localhost:8080/${PACKAGE_PATH}/ || echo "Warning: Failed to download some files"
            
            # Also explicitly download internal packages
            echo "Downloading internal packages explicitly..."
            for pkg in internal/handlers internal/models internal/database internal/auth internal/stream internal/storage internal/websocket internal/audio internal/email internal/middleware internal/queue internal/search internal/seed internal/recommendations; do
              echo "  Downloading ${PACKAGE_PATH}/$pkg..."
              wget -q \
                --convert-links \
                --adjust-extension \
                --page-requisites \
                --no-parent \
                --no-host-directories \
                --cut-dirs=0 \
                --directory-prefix=docs/_build/html/backend/godoc \
                --accept="*.html" \
                http://localhost:8080/${PACKAGE_PATH}/$pkg/ || echo "    Note: $pkg may not exist"
            done
            
            # Fix any remaining localhost URLs to use relative paths
            # Also fix absolute paths in JavaScript files
            echo "Fixing any remaining absolute URLs in HTML and JS files..."
            find docs/_build/html/backend/godoc -name "*.html" -o -name "*.js" | while read f; do
              # Calculate relative depth from godoc root
              REL_PATH=$(echo "$f" | sed 's|docs/_build/html/backend/godoc/||')
              
              # For JS files in static/, paths like /static/ should be relative to godoc root
              # Calculate depth from godoc root, not from JS file location
              if [[ "$f" == *.js ]] && [[ "$REL_PATH" == static/* ]]; then
                # JS file in static/ - need to go up to godoc root, then into static/
                # File: static/frontend/frontend.js -> needs ../../ to get to godoc root
                # Then /static/ paths should become ../../static/
                JS_DEPTH=$(echo "$REL_PATH" | tr -cd '/' | wc -c)
                if [ $JS_DEPTH -gt 0 ]; then
                  REL_PREFIX=$(printf '../%.0s' $(seq 1 $JS_DEPTH))
                else
                  REL_PREFIX="../"
                fi
                # For /static/ references in JS files, replace with relative path from godoc root
                sed -i \
                  -e 's|"/static/|"'${REL_PREFIX}'static/|g' \
                  -e "s|'/static/|'"${REL_PREFIX}"'static/|g" \
                  -e 's|http://localhost:8080/static/|'${REL_PREFIX}'static/|g' \
                  "$f" || true
              else
                # HTML file or JS file not in static/ - calculate depth normally
                if [ -n "$REL_PATH" ] && [ "$REL_PATH" != "index.html" ]; then
                  # Count directory separators (depth from godoc root)
                  # github.com/zfogg/sidechain/backend/index.html has 4 slashes = 4 levels deep
                  REL_DEPTH=$(echo "$REL_PATH" | sed 's|[^/]*$||' | tr -cd '/' | wc -c)
                  if [ $REL_DEPTH -gt 0 ]; then
                    REL_PREFIX=$(printf '../%.0s' $(seq 1 $REL_DEPTH))
                  else
                    REL_PREFIX=""
                  fi
                else
                  REL_PREFIX=""
                fi
                
                # Replace localhost URLs with relative paths
                # Also fix absolute paths starting with /static/ or /github.com/ in HTML and JS
                sed -i \
                  -e 's|http://localhost:8080/static/|'${REL_PREFIX}'static/|g' \
                  -e 's|http://localhost:8080/github.com/|'${REL_PREFIX}'github.com/|g' \
                  -e 's|http://localhost:8080/|'${REL_PREFIX}'|g' \
                  -e 's|"/static/|"'${REL_PREFIX}'static/|g' \
                  -e "s|'/static/|'"${REL_PREFIX}"'static/|g" \
                  -e 's|"/github.com/|"'${REL_PREFIX}'github.com/|g' \
                  -e "s|'/github.com/|'"${REL_PREFIX}"'github.com/|g" \
                  "$f" || true
              fi
            done
            
            echo "Package download completed"
            # List what we got
            echo "Downloaded files:"
            find docs/_build/html/backend/godoc -name "*.html" -type f 2>/dev/null | head -15 || echo "No HTML files found"
          else
            echo "Warning: Package path not accessible at http://localhost:8080/${PACKAGE_PATH}/"
          fi
          
          # Verify we got the files (check for package pages even if index.html failed)
          if [ -f "docs/_build/html/backend/godoc/index.html" ] || [ -f "docs/_build/html/backend/godoc/${PACKAGE_PATH}/index.html" ]; then
            echo "✓ Go documentation generated successfully"
            HTML_COUNT=$(find docs/_build/html/backend/godoc -name "*.html" 2>/dev/null | wc -l)
            echo "  Downloaded $HTML_COUNT HTML files"
          else
            echo "✗ Failed to generate Go documentation - no HTML files found"
            exit 1
          fi
          
          # Stop pkgsite
          kill $PKGSITE_PID || true
          wait $PKGSITE_PID 2>/dev/null || true
          
          # Create symlink for zfogg/sidechain path (without github.com prefix)
          # This matches the links in docs/backend/index.rst
          echo "Creating symlink for zfogg/sidechain path..."
          if [ -d "docs/_build/html/backend/godoc/github.com/zfogg/sidechain" ] && [ ! -d "docs/_build/html/backend/godoc/zfogg" ]; then
            mkdir -p docs/_build/html/backend/godoc/zfogg
            ln -sf ../github.com/zfogg/sidechain docs/_build/html/backend/godoc/zfogg/sidechain || \
            cp -r docs/_build/html/backend/godoc/github.com/zfogg/sidechain docs/_build/html/backend/godoc/zfogg/sidechain
            echo "✓ Created zfogg/sidechain path"
          fi

      - name: Build Sphinx documentation
        working-directory: docs
        env:
          DOXYGEN_XML_DIR: ${{ github.workspace }}/docs/doxygen/xml
          PYTHONPATH: ${{ github.workspace }}/docs
        run: |
          # Build Sphinx documentation (includes plugin API from Doxygen XML)
          # No C++ compilation needed - Doxygen already parsed the source files
          make html
          
          # Ensure backend godoc directory exists in output (if not already created)
          mkdir -p _build/html/backend/godoc || true
          
          # Verify godoc was generated
          if [ ! -f "_build/html/backend/godoc/index.html" ]; then
            echo "Warning: Go documentation not found, creating placeholder"
            mkdir -p _build/html/backend/godoc
            echo "<html><body><h1>Go Package Documentation</h1><p>Go documentation will be available after first successful build.</p></body></html>" > _build/html/backend/godoc/index.html
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/_build/html

  deploy:
    runs-on: ubuntu-latest
    needs: build-docs
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

