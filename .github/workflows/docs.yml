name: Build and Deploy Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'plugin/**/*.cpp'
      - 'plugin/**/*.h'
      - 'backend/**/*.go'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git tags/version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install -r docs/requirements.txt

      - name: Set up Go
        uses: actions/setup-golang@v5
        with:
          go-version: '1.24'

      - name: Install Go documentation tool
        run: |
          go install golang.org/x/tools/cmd/godoc@latest

      - name: Set up Node.js (for plugin build tools if needed)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build plugin documentation (Doxygen + Sphinx)
        env:
          DOXYGEN_XML_DIR: ${{ github.workspace }}/docs/doxygen/xml
        run: |
          # Install dependencies
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz ninja-build cmake

          # Configure and build plugin docs
          cd plugin
          cmake -S . -B build-docs \
            -G Ninja \
            -DSIDECHAIN_BUILD_DOCS=ON \
            -DCMAKE_BUILD_TYPE=Release

          cmake --build build-docs --target docs

          # Ensure Doxygen XML output exists
          if [ ! -d "${{ github.workspace }}/docs/doxygen/xml" ]; then
            echo "Doxygen XML not found, creating placeholder"
            mkdir -p "${{ github.workspace }}/docs/doxygen/xml"
          fi

      - name: Generate Go package documentation
        run: |
          # Install wget for downloading godoc pages
          sudo apt-get install -y wget
          
          # Generate godoc HTML documentation
          mkdir -p docs/_build/html/backend/godoc
          
          # Start godoc server in background
          ~/go/bin/godoc -http=:6060 &
          GODOC_PID=$!
          
          # Wait for server to start
          sleep 5
          
          # Download all package pages using wget with proper options
          # Create lib directory for assets
          mkdir -p docs/_build/html/backend/godoc/lib
          
          # Download CSS and JS assets (with error handling)
          wget -q -P docs/_build/html/backend/godoc/lib http://localhost:6060/lib/godoc.js || echo "Warning: Failed to download godoc.js"
          wget -q -P docs/_build/html/backend/godoc/lib http://localhost:6060/lib/jquery.js || echo "Warning: Failed to download jquery.js"
          wget -q -P docs/_build/html/backend/godoc/lib http://localhost:6060/lib/jquery.treeview.css || echo "Warning: Failed to download jquery.treeview.css"
          wget -q -P docs/_build/html/backend/godoc/lib http://localhost:6060/lib/jquery.treeview.js || echo "Warning: Failed to download jquery.treeview.js"
          wget -q -P docs/_build/html/backend/godoc/lib http://localhost:6060/lib/playground.js || echo "Warning: Failed to download playground.js"
          
          # Download main pages
          wget -q -P docs/_build/html/backend/godoc http://localhost:6060/ --output-document=index.html || echo "Warning: Failed to download index.html"
          wget -q -P docs/_build/html/backend/godoc http://localhost:6060/pkg/ --output-document=pkg.html || echo "Warning: Failed to download pkg.html"
          
          # Download our backend packages recursively
          wget -q \
            --recursive \
            --level=10 \
            --no-parent \
            --no-host-directories \
            --cut-dirs=1 \
            --convert-links \
            --adjust-extension \
            --page-requisites \
            --directory-prefix=docs/_build/html/backend/godoc \
            http://localhost:6060/pkg/github.com/zfogg/sidechain/backend/ || echo "Warning: Failed to download some package pages"
          
          # Fix paths in downloaded HTML files to use relative paths
          find docs/_build/html/backend/godoc -name "*.html" -type f 2>/dev/null | while read f; do
            sed -i \
              -e 's|href="/lib/|href="lib/|g' \
              -e 's|src="/lib/|src="lib/|g' \
              -e 's|href="/pkg/|href="pkg/|g' \
              -e 's|action="/search|action="search|g' \
              "$f" || true
          done
          
          # Stop godoc
          kill $GODOC_PID || true
          wait $GODOC_PID 2>/dev/null || true

      - name: Build Sphinx documentation
        working-directory: docs
        env:
          DOXYGEN_XML_DIR: ${{ github.workspace }}/docs/doxygen/xml
          PYTHONPATH: ${{ github.workspace }}/docs
        run: |
          # Build Sphinx documentation (includes plugin API from Doxygen)
          make html
          
          # Ensure backend godoc directory exists in output (if not already created)
          mkdir -p _build/html/backend/godoc || true
          
          # Verify godoc was generated
          if [ ! -f "_build/html/backend/godoc/index.html" ]; then
            echo "Warning: Go documentation not found, creating placeholder"
            mkdir -p _build/html/backend/godoc
            echo "<html><body><h1>Go Package Documentation</h1><p>Go documentation will be available after first successful build.</p></body></html>" > _build/html/backend/godoc/index.html
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/_build/html

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-docs
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

