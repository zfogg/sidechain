name: Deploy Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'plugin/**/*.cpp'
      - 'plugin/**/*.h'
      - 'backend/**/*.go'
      - '.github/workflows/docs.yml'
      - 'docs/CMakeLists.txt'
      - 'docs/conf.py'
      - 'docs/**/*.rst'
      - 'docs/**/*.md'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git tags/version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install -r docs/requirements.txt
          # Verify Sphinx is installed
          python3 -m sphinx --version

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install Go documentation tool
        run: |
          go install golang.org/x/pkgsite/cmd/pkgsite@latest

      - name: Set up Node.js (for plugin build tools if needed)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build plugin documentation (Doxygen only - no C++ compilation)
        env:
          DOXYGEN_XML_DIR: ${{ github.workspace }}/docs/doxygen/xml
        run: |
          # Install only documentation tools - no C++ build dependencies
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz cmake ninja-build

          # Build docs directly from docs/ directory (standalone, no plugin build)
          # This only runs Doxygen to parse C++ source files (no compilation)
          cd docs
          cmake -S . -B build-docs

          cmake --build build-docs --target docs-doxygen

          # Doxygen XML is already in the expected location: docs/build-docs/doxygen/xml
          # Copy it to docs/doxygen/xml for Sphinx
          if [ -d "build-docs/doxygen/xml" ]; then
            echo "Copying Doxygen XML to expected location for Sphinx"
            mkdir -p "${{ github.workspace }}/docs/doxygen"
            cp -r build-docs/doxygen/xml "${{ github.workspace }}/docs/doxygen/"
          else
            echo "Warning: Doxygen XML not found, creating placeholder"
            mkdir -p "${{ github.workspace }}/docs/doxygen/xml"
          fi

      - name: Generate Go package documentation
        run: |
          # Install wget and curl for downloading pkgsite pages
          sudo apt-get install -y wget curl
          
          # Use the generate-pkgsite.sh script to ensure consistency
          # The script handles starting pkgsite server and downloading all pages
          chmod +x docs/generate-pkgsite.sh
          ./docs/generate-pkgsite.sh
          
          # Verify we got the files
          if [ -f "docs/_build/html/backend/godoc/github.com/zfogg/sidechain/backend/index.html" ]; then
            echo "✓ Go documentation generated successfully"
            HTML_COUNT=$(find docs/_build/html/backend/godoc -name "*.html" 2>/dev/null | wc -l)
            echo "  Downloaded $HTML_COUNT HTML files"
          else
            echo "✗ Failed to generate Go documentation - no HTML files found"
            exit 1
          fi

      - name: Build Sphinx documentation
        working-directory: docs
        env:
          DOXYGEN_XML_DIR: ${{ github.workspace }}/docs/doxygen/xml
          PYTHONPATH: ${{ github.workspace }}/docs
        run: |
          # Build Sphinx documentation (includes plugin API from Doxygen XML)
          # No C++ compilation needed - Doxygen already parsed the source files
          make html
          
          # Ensure backend godoc directory exists in output (if not already created)
          mkdir -p _build/html/backend/godoc || true
          
          # Verify godoc was generated
          if [ ! -f "_build/html/backend/godoc/index.html" ]; then
            echo "Warning: Go documentation not found, creating placeholder"
            mkdir -p _build/html/backend/godoc
            echo "<html><body><h1>Go Package Documentation</h1><p>Go documentation will be available after first successful build.</p></body></html>" > _build/html/backend/godoc/index.html
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/_build/html

  deploy:
    runs-on: ubuntu-latest
    needs: build-docs
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

