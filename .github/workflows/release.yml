name: Release Plugin

on:
  push:
    tags:
      - 'plugin/v*.*.*'

jobs:
  build-plugin:
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Universal (Intel + Apple Silicon)
          - os: macos-15
            name: macOS
            cmake_args: -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"
            cmake_preset: release-no-vcpkg
            artifact_name: Sidechain-macOS-universal
            artifact_path: plugin/build/src/core/Sidechain_artefacts/Release

          # Linux (x86_64)
          - os: ubuntu-latest
            name: Linux
            cmake_args: ""
            cmake_preset: release-no-vcpkg
            artifact_name: Sidechain-Linux-x86_64
            artifact_path: plugin/build/src/core/Sidechain_artefacts/Release

          # Windows (x86_64)
          - os: windows-latest
            name: Windows
            cmake_args: -G "Visual Studio 17 2022" -A x64
            cmake_preset: release-no-vcpkg
            artifact_name: Sidechain-Windows-x86_64
            artifact_path: plugin/build/src/core/Sidechain_artefacts/Release

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        uses: ./.github/actions/install-deps

      - name: Cache Build Dependencies
        uses: ./.github/actions/cache-build
        with:
          arch: ${{ matrix.name == 'macOS' && 'universal' || 'x86_64' }}

      - name: Configure CMake
        run: cmake -S plugin -B plugin/build ${{ matrix.cmake_args }} --preset ${{ matrix.cmake_preset }}

      - name: Build Plugin
        run: cmake --build plugin/build --config release --parallel

      - name: Save Build Cache
        if: always()
        uses: ./.github/actions/save-build-cache
        with:
          cache-version: '1'
          arch: ${{ matrix.name == 'macOS' && 'universal' || 'x86_64' }}

      - name: Package VST3 (macOS)
        if: runner.os == 'macOS'
        run: |
          cd ${{ matrix.artifact_path }}
          zip -r ../../../${{ matrix.artifact_name }}-VST3.zip VST3/
          zip -r ../../../${{ matrix.artifact_name }}-AU.zip AU/

      - name: Package VST3 (Linux)
        if: runner.os == 'Linux'
        run: |
          cd ${{ matrix.artifact_path }}
          zip -r ../../../${{ matrix.artifact_name }}-VST3.zip VST3/

      - name: Package VST3 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "${{ matrix.artifact_path }}/VST3/*" -DestinationPath "plugin/${{ matrix.artifact_name }}-VST3.zip"

      - name: Upload VST3 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-VST3
          path: plugin/${{ matrix.artifact_name }}-VST3.zip

      - name: Upload AU Artifact (macOS only)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-AU
          path: plugin/${{ matrix.artifact_name }}-AU.zip

  create-release:
    needs: build-plugin
    runs-on: ubuntu-latest
    name: Create Release
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List Artifacts
        run: find artifacts -type f

      - name: Generate Changelog
        id: changelog
        run: |
          # Get the previous plugin tag (e.g., plugin/v0.0.1)
          CURRENT_TAG="${{ github.ref_name }}"
          # Extract version for finding previous tag (e.g., v0.0.1 from plugin/v0.0.1)
          COMPONENT=$(echo "$CURRENT_TAG" | cut -d'/' -f1)
          PREV_TAG=$(git tag --list "$COMPONENT/v*" --sort=-v:refname --merged HEAD 2>/dev/null | head -2 | tail -1 || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "First release - including all commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            echo "Generating changelog from $PREV_TAG to $CURRENT_TAG"
            COMMITS=$(git log $PREV_TAG..$CURRENT_TAG --pretty=format:"- %s (%h)" --reverse)
          fi

          # Create changelog with categories
          CHANGELOG="## What's Changed"$'\n\n'

          # Features
          FEATURES=$(echo "$COMMITS" | grep -E "^- (feat|feature)" || true)
          if [ ! -z "$FEATURES" ]; then
            CHANGELOG+="### âœ¨ Features"$'\n'"$FEATURES"$'\n\n'
          fi

          # Fixes
          FIXES=$(echo "$COMMITS" | grep -E "^- (fix|bugfix)" || true)
          if [ ! -z "$FIXES" ]; then
            CHANGELOG+="### ðŸ› Bug Fixes"$'\n'"$FIXES"$'\n\n'
          fi

          # Other changes
          OTHER=$(echo "$COMMITS" | grep -vE "^- (feat|feature|fix|bugfix)" || true)
          if [ ! -z "$OTHER" ]; then
            CHANGELOG+="### ðŸ”§ Other Changes"$'\n'"$OTHER"$'\n\n'
          fi

          # Write to file for multiline output
          echo "$CHANGELOG" > changelog.txt
          cat changelog.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Sidechain Plugin ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          body_path: changelog.txt
          files: |
            artifacts/Sidechain-macOS-universal-VST3/*.zip
            artifacts/Sidechain-macOS-universal-AU/*.zip
            artifacts/Sidechain-Linux-x86_64-VST3/*.zip
            artifacts/Sidechain-Windows-x86_64-VST3/*.zip
