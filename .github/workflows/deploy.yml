name: Deploy Backend to Production

on:
  workflow_run:
    workflows: [ "Build and Push Backend Docker Image" ]
    types: [ completed ]
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  DEPLOYMENT_DIR: /opt/sidechain/backend
  DOCKER_COMPOSE_FILE: docker-compose.prod.yml

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    environment: production  # Optional: use GitHub environments for secrets

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_SERVER_HOST }}
          username: ${{ secrets.DEPLOY_SERVER_USER }}
          port: ${{ secrets.DEPLOY_SERVER_PORT }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script_stop: true  # Stop on first error
          script: |
            set -euo pipefail

            echo "=== Deploying Sidechain Backend ==="
            cd /opt/sidechain

            # Pull latest code
            echo "→ Pulling latest code from main branch..."
            git fetch origin main
            git reset --hard origin/main

            # Move to backend directory
            cd ${{ env.DEPLOYMENT_DIR }}

            # Check if docker-compose file exists
            if [ ! -f "${{ env.DOCKER_COMPOSE_FILE }}" ]; then
              echo "✗ Docker compose file not found: ${{ env.DOCKER_COMPOSE_FILE }}"
              exit 1
            fi

            # Load environment variables
            if [ ! -f .env ]; then
              echo "✗ .env file not found at $(pwd)/.env. Please configure it first."
              exit 1
            fi

            echo "→ Sourcing environment variables..."
            set -a
            source .env
            set +a

            # Validate domain is set
            if [ -z "${DOMAIN:-}" ]; then
              echo "✗ DOMAIN not set in .env"
              exit 1
            fi

            # Validate critical environment variables
            required_vars=(
              "POSTGRES_USER"
              "POSTGRES_PASSWORD"
              "POSTGRES_DB"
              "JWT_SECRET"
            )

            for var in "${required_vars[@]}"; do
              if [ -z "${!var:-}" ]; then
                echo "✗ Missing required environment variable: $var"
                exit 1
              fi
            done

            # Pull latest image
            echo "→ Pulling latest backend image..."
            docker pull zfogg/sidechain-backend:latest

            # Stop old containers gracefully
            echo "→ Stopping old containers..."
            docker-compose -f "${{ env.DOCKER_COMPOSE_FILE }}" down || true

            # Update gorse.toml with production credentials
            echo "→ Updating gorse.toml with production credentials..."
            sed -i "s/sidechain_dev_password/${POSTGRES_PASSWORD}/g" gorse.toml

            # Start new containers with latest image
            echo "→ Starting containers with latest image..."
            docker-compose -f "${{ env.DOCKER_COMPOSE_FILE }}" up -d

            # Wait for services to be ready
            echo "→ Waiting for services to be ready..."
            sleep 5

            # Check if containers are running
            echo "→ Checking container status..."
            docker-compose -f "${{ env.DOCKER_COMPOSE_FILE }}" ps

            # Check if containers are healthy
            echo "→ Checking container health..."
            max_attempts=30
            attempt=0
            while [ $attempt -lt $max_attempts ]; do
              # Check if backend container is running
              if docker-compose -f "${{ env.DOCKER_COMPOSE_FILE }}" ps backend | grep -q "Up"; then
                echo "✓ Backend container is running"
                break
              fi
              attempt=$((attempt + 1))
              if [ $attempt -eq $max_attempts ]; then
                echo "✗ Backend container failed to start after $max_attempts attempts"
                docker-compose -f "${{ env.DOCKER_COMPOSE_FILE }}" logs backend
                exit 1
              fi
              echo "  Attempt $attempt/$max_attempts - waiting for container..."
              sleep 1
            done

            # Show deployment info
            echo ""
            echo "=== Deployment Complete ==="
            echo "Server: ${{ secrets.DEPLOY_SERVER_HOST }}"
            echo "API: https://${DOMAIN}"
            echo "Caddy Dashboard: https://${DOMAIN}/admin/caddy"
            echo ""
            docker-compose -f "${{ env.DOCKER_COMPOSE_FILE }}" ps

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Deployment failed. Check the workflow run for details.'
            })

  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "✓ Deployment successful to ${{ secrets.DEPLOY_SERVER_HOST }}"
          else
            echo "✗ Deployment failed"
            exit 1
          fi
