name: Build and Push Backend Docker Image

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/build-and-push.yml'
  workflow_dispatch:

jobs:
  build-and-push:
    name: Build Docker Image on GitHub Runner
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production
        env:
          SSH_HOST: ${{ secrets.DEPLOY_SERVER_HOST }}
          SSH_USER: ${{ secrets.DEPLOY_SERVER_USER }}
          SSH_PORT: ${{ secrets.DEPLOY_SERVER_PORT }}
          SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p $SSH_PORT -H $SSH_HOST >> ~/.ssh/known_hosts 2>/dev/null

          # Deploy: pull latest code and rebuild with resource limits
          ssh -i ~/.ssh/id_ed25519 -p $SSH_PORT $SSH_USER@$SSH_HOST << 'EOF'
          set -e
          cd /opt/sidechain/backend
          echo "ðŸ“¥ Fetching latest code..."
          git fetch origin main
          git reset --hard origin/main
          git checkout origin/main
          echo "ðŸ”¨ Building Docker image with resource limits..."
          docker build --memory=1g --memory-swap=1g --cpus="1" -t zfogg/sidechain-backend:latest .
          echo "âœ… Docker image built successfully"
          echo "ðŸš€ Restarting all services..."
          docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
          echo "â³ Waiting for services to be healthy..."
          for i in {1..30}; do
            if docker exec sidechain-backend wget --no-verbose --tries=1 --spider http://localhost:8787/health 2>/dev/null; then
              echo "âœ… Backend is healthy!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          echo "âœ… Checking Caddy is ready..."
          for i in {1..10}; do
            if docker exec sidechain-caddy curl -s http://localhost:80 >/dev/null 2>&1 || docker exec sidechain-caddy curl -s https://localhost:443 >/dev/null 2>&1; then
              echo "âœ… Caddy is ready!"
              break
            fi
            echo "Waiting for Caddy... ($i/10)"
            sleep 2
          done
          echo "ðŸŽ‰ Deployment complete!"
          EOF
