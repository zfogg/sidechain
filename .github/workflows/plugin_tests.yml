name: Build and Test Plugin

on:
  push:
    branches: [main]
    paths:
      - 'plugin/**/*.cpp'
      - 'plugin/**/*.h'
      - 'plugin/**/*.cmake'
      - 'plugin/CMakeLists.txt'
      - 'plugin/**/CMakeLists.txt'
      - 'plugin/Sidechain.jucer'
      - 'plugin/cmake/**'
      - '.github/workflows/plugin_tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'plugin/**/*.cpp'
      - 'plugin/**/*.h'
      - 'plugin/**/*.cmake'
      - 'plugin/CMakeLists.txt'
      - 'plugin/**/CMakeLists.txt'
      - 'plugin/Sidechain.jucer'
      - 'plugin/cmake/**'
      - '.github/workflows/plugin_tests.yml'

# Permissions needed for dorny/test-reporter to create check runs
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  build-plugin:
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Intel (x86_64)
          - os: macos-13
            name: macOS-Intel
            cmake_args: ""
            artifact_path: plugin/build/Sidechain_artefacts/Release

          # macOS Apple Silicon (arm64)
          - os: macos-14
            name: macOS-ARM64
            cmake_args: ""
            artifact_path: plugin/build/Sidechain_artefacts/Release

          # Linux (x86_64)
          - os: ubuntu-latest
            name: Linux
            cmake_args: ""
            artifact_path: plugin/build/Sidechain_artefacts/Release

          # Windows (x86_64)
          - os: windows-latest
            name: Windows
            cmake_args: -G "Visual Studio 17 2022" -A x64
            artifact_path: plugin/build/Sidechain_artefacts/Release

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        uses: ./.github/actions/install-deps

      - name: Cache Build Dependencies
        uses: ./.github/actions/cache-build
        with:
          arch: ${{ matrix.name == 'macOS-ARM64' && 'arm64' || matrix.name == 'macOS-Intel' && 'x86_64' || 'x86_64' }}

      - name: Configure CMake
        run: cmake -S plugin -B plugin/build ${{ matrix.cmake_args }} -DCMAKE_BUILD_TYPE=Release

      - name: Build Plugin
        run: |
          # Limit parallel jobs on Linux to avoid OOM (GitHub runners have limited RAM)
          if [ "$RUNNER_OS" = "Linux" ]; then
            cmake --build plugin/build --config Release --parallel 2
          else
            cmake --build plugin/build --config Release --parallel
          fi
        shell: bash

      - name: List Build Artifacts
        shell: bash
        run: |
          echo "Build artifacts:"
          find plugin/build/Sidechain_artefacts -type f -name "*.vst3" -o -name "*.component" -o -name "*.dll" -o -name "*.so" 2>/dev/null || true
          ls -la ${{ matrix.artifact_path }} || true

      - name: Upload VST3 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Sidechain-VST3-${{ matrix.name }}
          path: ${{ matrix.artifact_path }}/VST3/
          if-no-files-found: error

      - name: Upload AU Artifact (macOS only)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: Sidechain-AU-${{ matrix.name }}
          path: ${{ matrix.artifact_path }}/AU/
          if-no-files-found: error

      - name: Upload Standalone Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Sidechain-Standalone-${{ matrix.name }}
          path: ${{ matrix.artifact_path }}/Standalone/
          if-no-files-found: warn

  test-plugin:
    runs-on: ubuntu-latest
    name: Plugin Tests & Coverage

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        uses: ./.github/actions/install-deps
        with:
          with-coverage: 'true'

      - name: Cache Build Dependencies
        uses: ./.github/actions/cache-build

      - name: Configure CMake with Tests and Coverage
        run: |
          cmake -S plugin -B plugin/build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DSIDECHAIN_BUILD_TESTS=ON \
            -DSIDECHAIN_ENABLE_COVERAGE=ON \
            -DSIDECHAIN_BUILD_PLUGIN_HOST=OFF

      - name: Build Tests
        run: cmake --build plugin/build --config Debug --target SidechainTests --parallel

      - name: Run Tests
        run: |
          cd plugin/build
          # Create test-results directory for Catch2 JUnit output
          mkdir -p test-results
          ctest --output-on-failure -C Debug --output-junit test-results.xml

      - name: Generate Coverage Report
        run: |
          lcov --capture --directory plugin/build --output-file plugin/build/coverage.info \
            --ignore-errors mismatch,source,gcov
          lcov --remove plugin/build/coverage.info \
            '/usr/*' \
            '*/deps/*' \
            '*/_deps/*' \
            '*/Catch2/*' \
            '*/build/*' \
            --output-file plugin/build/coverage.info --ignore-errors unused
          lcov --list plugin/build/coverage.info

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: plugin/build/coverage.info
          flags: plugin
          name: plugin-coverage
          fail_ci_if_error: false
          verbose: true

      - name: Upload Test Results Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: plugin-test-results
          path: plugin/build/test-results.xml
          if-no-files-found: warn

      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Plugin Unit Tests
          path: plugin/build/test-results.xml
          reporter: java-junit
          fail-on-error: true

      - name: Upload JUnit to Codecov
        uses: codecov/test-results-action@v1
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: plugin/build/test-results.xml
          flags: plugin
          name: plugin-tests
          fail_ci_if_error: false
