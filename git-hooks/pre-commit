#!/usr/bin/env bash

# Pre-commit hook for Sidechain
# - Formats C/C++ code with clang-format
# - Builds TypeScript/web code if changed
# - Builds Go backend if changed
# - Builds Go CLI if changed
# - Builds C++ plugin if changed

set -e  # Exit on error

# Get list of staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM || true)

if [[ -z "$staged_files" ]]; then
    exit 0
fi

# Check what types of files changed
has_typescript=false
has_backend=false
has_cli=false
has_cpp=false

# Check for TypeScript/web changes
if echo "$staged_files" | grep -qE '^web/.*\.(ts|tsx|js|jsx)$'; then
    has_typescript=true
fi

# Check for Go backend changes
if echo "$staged_files" | grep -qE '^backend/.*\.go$'; then
    has_backend=true
fi

# Check for Go CLI changes
if echo "$staged_files" | grep -qE '^cli/.*\.go$'; then
    has_cli=true
fi

# Check for C++ plugin changes (source files or CMake files)
if echo "$staged_files" | grep -qE '^plugin/.*\.(cpp|h|hpp|c)$'; then
    has_cpp=true
fi

# Check for CMake changes (affects plugin build)
if echo "$staged_files" | grep -qE '\.(cmake|CMakeLists\.txt)$'; then
    has_cpp=true
fi

# Format C/C++ files
cpp_files=$(echo "$staged_files" | grep -E '\.(c|h|cpp|hpp|m|mm)$' || true)
if [[ -n "$cpp_files" ]]; then
    echo "ğŸ¨ Formatting C/C++ files..."
    formatted_files=""
    for file in $cpp_files; do
        if [[ -f "$file" ]]; then
            clang-format -i "$file"
            # Check if file was modified by formatting
            if git diff --name-only | grep -q "^$file$"; then
                formatted_files="$formatted_files $file"
                git add "$file"
            fi
        fi
    done
    
    if [[ -n "$formatted_files" ]]; then
        echo "âœ… Code formatting applied to:$formatted_files"
    fi
fi

# Save original directory
ORIGINAL_DIR=$(pwd)

# Build TypeScript/web if changed
if [[ "$has_typescript" == true ]]; then
    echo "ğŸ”¨ Building TypeScript/web code..."
    if ! (cd web && npm run build); then
        echo "âŒ TypeScript build failed. Please fix errors before committing."
        exit 1
    fi
    echo "âœ… TypeScript build succeeded"
fi

# Build Go backend if changed
if [[ "$has_backend" == true ]]; then
    echo "ğŸ”¨ Building Go backend..."
    if ! (cd backend && go build ./cmd/server/main.go); then
        echo "âŒ Backend build failed. Please fix errors before committing."
        exit 1
    fi
    echo "âœ… Backend build succeeded"
fi

# Build Go CLI if changed
if [[ "$has_cli" == true ]]; then
    echo "ğŸ”¨ Building Go CLI..."
    if ! (cd cli && go build -o bin/sidechain ./cmd/main.go); then
        echo "âŒ CLI build failed. Please fix errors before committing."
        exit 1
    fi
    echo "âœ… CLI build succeeded"
fi

# Build C++ plugin if changed
if [[ "$has_cpp" == true ]]; then
    echo "ğŸ”¨ Building C++ plugin..."
    if ! make plugin-fast > /dev/null 2>&1; then
        echo "âŒ Plugin build failed. Please fix errors before committing."
        echo "   Run 'make plugin-fast' manually to see detailed error messages."
        exit 1
    fi
    echo "âœ… Plugin build succeeded"
fi

exit 0
